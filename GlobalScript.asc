#define DEFAULT_GAMESPEED 40

/* Implementation of struct Flags (Quest codes) */
function Flags::Init(){
    flags.Chapter = 0; // Current chapter of the game

		// Generic Flags
		flags.UpperLibraryDoorUnlocked = 0;
    flags.FlanaginnRented = 0;
		
		flags.VisitedDarkForest = 0;
		
		flags.VisitedForestFirstTime = 0;
		
		flags.HadEloiaDream = 0;
		flags.AmbushCutScene = 0;
		
		// -- Chapter 1 Quest Related Flags --
		
		flags.IntroFight = 0;
		flags.SeenCh1JobBoard = 0;
		
		// Perfect Name Quest
		flags.GolemName = 0;
		flags.ShownBentSwordToRonBars = 0;
		flags.AlbionGateFixed = 0;

		// Finding the Duke
		flags.DukeRescue = 0;
		flags.SeenSymbols = 0;
		flags.AskedGolemAboutSymbols = 0;
		flags.KnowOfRemanBook = 0;
		
		flags.KilledGuardGolem = 0;
		flags.litCaveTorch = 0;
		
		// Sidhe Meeting #1
		
		flags.MetMharryon1 = 0;
		
		//  -- Chapter 2 Quest Related Flags -- 
		flags.MobOccuring = 0;
		
		flags.DolmenQuest = 0;
		flags.BloodSealVersion = 0;
		
		flags.GreenleafFavor = 0;
		flags.NiallDuel = 0;
		flags.hadStatueCutscene = 0;
		flags.StatueCutSceneSequence = 0;
		
		flags.CanSeeInDarkForest = 0;
		flags.AngusNote = 0;
		flags.ShadowMageApproaching = 0;
		
		flags.SeenDarkSymbol = 0;
		
		flags.TowerQuest = 0;
		flags.TowerRiddles = 0;
		
		flags.DisturbedFernin = 0;
		flags.DayTheMagicShopReopens = 0;
		
		flags.RumorsMarvin = 0;

		//short ConalLovesGreenleaf;
		
		//short QstLlewellaHealing;

		//short FoxRescue;

		//short HeroRescue; // Saved by Kara/Greenleaf?

		flags.FlanaganDebt = 0;
		flags.FlanaganSum = 0;
		flags.FlanaganDebtLlewella = 0;
		flags.FlanaganDebtSigurd = 0;
		flags.FlanaganDebtThaen = 0;
		flags.FlanaganRoom = 0;
		
		flags.LostSpellbook = 0;
		flags.FamilyBroach = 0;
		flags.LostLibraryBook = 0;
		flags.Ingredients = 0;
		flags.DeirdreSong = 0;

		
		flags.HeroWantToFixMcWeirdWall = 0;	 // McWeird Wall Quest
		flags.McWeirdWall = 0;

		//short SheekarIll;		// 
		//short SheekarIllTC;		// Time Count: Hero has 3 days after talking with maren to help Sheekar or she dies
		
		flags.HeroRescueNiall = 0;	// dlgniall

		flags.HeroRescued = 0;

		flags.RogueCaptive = 0;		// initialized in dlgthaen
		//RogueCaptiveDay; 	// initialized in dlgthaen, make sure the quest doesn't last too long.
		//short QstRoguesCaptiveMcWeird;

		//short GlithThiefSign; // dlggilth

		// Tell Veran about these topics only once
		//short VeranBrooch;
		//short VeranAruthredd;
		//short VeranEscapedRogue;

		// Chapter 2 --------------

		flags.FerninClaySignatures = 0;
		flags.TethraSuggestRemenBookLibrary = 0;
		flags.ColletteTiara = 0;
		flags.CatacombsUnlocked = 0;
		flags.RemenCaptRing = 0;
		flags.BelenusBuyStatue = 0;
		flags.BelenusBuyCandles = 0;
		flags.BelenusBuyWoodenBox = 0;
		flags.BelenusBuyLiquid = 0;
		flags.GiveRonBarsGift = 0;
		flags.GiveTethraRemenAmulet = 0;
		flags.GiveTethraNullWater = 0;
		flags.GiveTethraBlade = 0;
		flags.Lorichol = 0;
		flags.Sidhestone = 0;
		flags.SerlaiInitiation = 0;
		
		// Scene-dependant Flags --

		flags.advguild21logbook = 0;
		
		flags.beenInBIHouse1 = 0;
		flags.BIHouse1_TakenSilverBox = 0;
		flags.BIHouse1_OpenedChest = 0;
		flags.BIHouse1_TakenBracelets = 0;
		flags.BIHouse1_FoundFireplaceSilver = 0;
		flags.Forest166_HighLuckCoin = 0;  //The high luck coin quest

		flags.armor_graveyd100 = 0;

		// Chapter 3 Quest Related Flags --

		flags.VeranBet = 0;
		
		// Dialog Related Flags --
		
		flags.ThaenIntroduced = 0;
		flags.AskedThaenAboutLibrary = 0;
		
		flags.DlgAngus = 0;
		flags.DlgBand = 0; 		// Seen the band?
		flags.DlgBelenus = 0;
		flags.DlgBryanCos = 0;	// Number of times (0,1, or 2) player has talked to Bryan Cos
		flags.DlgClothiers = 0;
		flags.DlgCollette = 0;
		flags.DlgConal = 0;
		flags.DlgDuke = 0;
		flags.DlgDeirdre = 0;
		flags.DlgEvonne = 0;	// Talked to Evonne?
		flags.DlgFlanagan = 0;
		flags.DlgFernin = 0;
		flags.DlgFerninCh2 = 0;
		flags.DlgGewitter = 0;
		flags.DlgGlith = 0;
		flags.DlgGreenleaf = 0;	// The first encounter is from Saved by Greenleaf quest
		flags.DlgHywell = 0;
    flags.DlgJulian = 0;
		flags.DlgKara = 0;
		flags.DlgKilian = 0;
		flags.DlgLlewella = 0;
		flags.DlgMaren = 0;
		flags.DlgMarvin = 0;
		flags.DlgMcWeird = 0;
		flags.DlgMharyon = 0;     // When this is 1, you will be in Underhill
		flags.DlgNiall = 0;
		flags.DlgOldSailor = 0;
		flags.DlgPierre = 0;
		flags.DlgPipawulf = 0;
		flags.DlgRemenCapt = 0;
		flags.DlgRowena = 0;
		flags.DlgSheekar = 0;
		flags.DlgTethra = 0;
		flags.DlgSigurd = 0;
		flags.DlgVeran = 0;
}


/* Implementation of struct HeroData Initialization */
function HeroData::Init(){
  heroinfo.hp = 150;
	heroinfo.mhp = 150;
	heroinfo.sp = 150;
	
	heroinfo.gold = 11;
	
	heroinfo.class = CLASS_FIGHTER;
	heroinfo.str=40;
	heroinfo.Int=20;
	heroinfo.agi=45;
	heroinfo.vit=50;
	heroinfo.luck=30;
	heroinfo.weaponuse=50;
	heroinfo.parry=30;
	heroinfo.dodge=30;
	heroinfo.climb=30;
	heroinfo.magic=70;
	heroinfo.stealth = 10;
	
	RefreshMaxHealthStat();
	RefreshMaxMagicStat();
	RefreshMaxStaminaStat();
	SetMaxHealth();
	SetMaxStamina();
	SetMaxMagic();
}


/********* AGS functions ***********************************************************************************************************/
/*** AGS.main  **********************************************************************************************************************/
function game_start() {
  // called when the game starts, before the first room is loaded
  //This message is the first thing the user will see
	SetRestartPoint ();
  Display("Hero6 is a fan-made game.  Thank you to all the heroes who made it possible to continue the quest.");
  
  flags.Init();
  //flags.Chapter = 0;
	
	// DEBUG
	//flags.MobOccuring = 3;
	//flags.DolmenQuest = 1;
	//flags.DukeRescue = 6;
  
  // init stats
	heroinfo.Init();
  
  // init combat module
	initCombatModule();
	
	// init combat grid
	InitializeGrid();
	
	// start game during the day
	timeinfo.ticks = 4000;
	
	gStats.Visible = false;
	gMonsterbox.Visible = false;
	gCombatbox.Visible = false;
	gCombatgui.Visible = false;
	gNoisemeter.Visible = false;
	
	InitializeClasses();
  
	cCriticaltext.Transparency = 100;
	cCriticaltext.Baseline = 240;
	cHeroshad.Transparency = 50;
  cRainCloud.Transparency = 100;
  
	// initialize certain quest variables
	flags.DayTheMagicShopReopens = 32767;
  
	InitializeRiddles();

  cFilter.Transparency = 0;
	// 
	SetTimer(Timer_Health, 40);
	SetTimer(Timer_Stamina, 40);
	SetTimer(Timer_Magic, 40);
  
  cFilter.Baseline = 300;
  
	SetGameSpeed(DEFAULT_GAMESPEED);
  
  //Intro music
  aMusic2.Play();
}
function repeatedly_execute_always() {
	//HandleShadows();  //I don't know if this looks right... The shadow doesn't 
} 
// method run every game frame by AGS, except when in blocking state (cutscene, etc)
function repeatedly_execute() {
  // put anything you want to happen every game cycle here
  
	UpdateTopBarLabels();
  /*if (IsTimerExpired(Timer_Stamina)==1) {
    Display("Timer 5 gone");
  }
  */
  
	updateCombat();

	// flame dart cast
	updateSpells();
}

function CompleteGreenleafFavor() {

cEgo.LoseInventory(iMagicFruit);
//cGreenleaf.Say("Anyway did you find the fruit you need?");
//Display("You give the fruit to Greenleaf.");
cGreenleaf.Say("Thank you for bring me the fruit. I shall now help you as promised.");
cGreenleaf.Say("The only way to see clearly in the dark forest is by drinking the water from this potion just before entering. ");
cGreenleaf.Say("One bottle should be able to help you for as much as you need.");
cGreenleaf.Say("Now that you have proven yourself capable, I trust that you will be able to take care of yourself in there. ");
cGreenleaf.Say("A word of caution though. Do not stay in the forest any longer than you need to, for it is fraught with danger. Good luck.");
Display("She hands you a flask of her special nullwater. You place it in your inventory.");

flags.GreenleafFavor = GREENLEAF_FAVOR_COMPLETE;
cEgo.AddInventory(iFlaskNullWater);
}
// Only function that may be used in AGS dialog scripts
// Perform any needed advanced dialog scripting */
function dialog_request(int X) {
  
  // Goodbye Llewella
	/*if (X == 1) {
    	if (timeinfo.Day<3) cLlewella.Say("Be safe.");
			else if (flags.EileenRescue<15) Display("Llewella nods, too distraught to respond.");
			else if (flags.EileenRescue==15) {
				cLlewella.Say("Goodbye hero, and forgive me for having doubting you. I am certain you will find fame and glory one day.");
				flags.EileenRescue = 16;
			}
			else cLlewella.Say("Be safe, my friend.");
	}*/
	
	// Hywel conversation
	if (X == 2) {
	  if (flags.DlgHywell == 0) {
	    cHywell.Say("Hi. I'm Hywel, the guildmaster here. I suppose you're another one of those heroes who's going to save Albion from the trouble that plagues it.");
	    flags.DlgHywell = 1;
	  }
	  else cHywell.Say("Hi again. If you want to be helpful, remember to check the questboard on the wall.");
	}
	
	if (X == 3) {
			if (flags.DlgVeran == 0) {
			  cVeran.Say("Well. Should I even bother to introduce myself?");
				cVeran.Say("What I mean is,");
				cVeran.Say("Do you intend to ignore me entirely,");
				cVeran.Say("Run headlong into the woods,");
				cVeran.Say("Be minced into a bloody mess,");
				cVeran.Say("And trip me during my morning stroll,");
				cVeran.Say("Completely ruining my appetite?");
				cHywell.Say("Belay, man, belay. He just wants to help. Might even want to train with you.");
				cVeran.Say("Introductions then. I'm Veran. And who would you be?");
				Display("You tell Veran your name.");
				cVeran.Say("Well, I hope you will prove more than just another ne'er-do-well glory seeker.");
				flags.DlgVeran = 1;
			}
		  else {
		    cVeran.Say("Well, it seems you have managed to remain healthy still. I hope for your sake this is not only luck.");
		  }
	}
	
	//initialise duke quest
	if (X == 4) {
	  if (flags.DukeRescue == 0) flags.DukeRescue = 1;
	}
	
	// seen symbols?
	if (X == 5) {
	  if (flags.SeenSymbols == true) {
			dColleen01.SetOptionState(8, eOptionOn);
			dColleen02.SetOptionState(8, eOptionOn);
		}
    if (flags.AskedGolemAboutSymbols == true) {
			dColleen01.SetOptionState(11, eOptionOn);
			dColleen02.SetOptionState(11, eOptionOn);
	  }
	}
	if (X == 6) {
	  Wait(40);
		cEgo.ChangeRoom(11, 130, 133);
	}
	if (X == 7) {
	  flags.KnowOfRemanBook = true;
	}
	if (X == 8) {
	  if (flags.Chapter == 1) {
			if (flags.DukeRescue == 5) {
				//dJulian01.SetOptionState(6, eOptionOn);
				dRowena01.SetOptionState(11, eOptionOn);
				dRowena01.SetOptionState(9, eOptionOff);
			}
	    else if (flags.DukeRescue < 5 && flags.SeenSymbols) {
				dRowena01.SetOptionState(11, eOptionOff);
				dRowena01.SetOptionState(9, eOptionOn);
			}  
		}
	}

  if (X == 9) {
    if (flags.Chapter == 2 && flags.MobOccuring == 4) {
			cBelenus.Say("Greetings. Have you discovered anything new since our last visit?");
		}
	}
  if (X == 10) {
    if (flags.Chapter == 2 && flags.MobOccuring == 3) {
      flags.MobOccuring = 4;
      
      if (heroinfo.class == CLASS_FIGHTER) {
				cBelenus.Say("I don't know whether you are strong enough to defeat the Duke's attacker.  Considering the Duke is a paladin, you had best think twice before engaging.");
				cBelenus.Say("Better take preparations just in case. Here are two healing potions");
				cEgo.AddInventory(iHealingPotion);
				cEgo.AddInventory(iHealingPotion);
			}
      else if (heroinfo.class == CLASS_MAGE) {
				cBelenus.Say("I sense you do have some magical skill. I don't know whether you will be able to hurt that magical creature with a direct magical attack.");
				cBelenus.Say("Be careful.");
				//cEgo.AddInventory(iManaPotion);
				//cEgo.AddInventory(iManaPotion);
			}
      else if (heroinfo.class == CLASS_THIEF) {
				cBelenus.Say("You're a brave man to search for the Duke's attacker. Be careful and keep your distance from that monster.");
				cBelenus.Say("This creature injured the Duke, himself a Paladin. I'm afraid it will be too much for your close combat skills. You had best equip yourself well.");
			}
		}
		cBelenus.Say("If you ever need healing, you know where to come.");
  }
  

	// buy health potion
	if (X == 11) {
		PurchaseItem(iHealingPotion, "You purchase a healing potion.");
	}
	// buy Stamina potion
	if (X == 12) {
	  PurchaseItem(iStaminaPotion, "You purchase a stamina potion.");
	}	
	// buy Mana potion
	if (X == 13) {
		PurchaseItem(iManaPotion, "You purchase a mana potion.");
	}	
	if (X == 14) {
	  if (flags.DlgGreenleaf == 1) dGreenleaf01.SetOptionState(2, eOptionOn);
	  else dGreenleaf01.SetOptionState(1, eOptionOn);
	  
	  if (flags.Chapter == 2 && flags.MobOccuring > 3) dGreenleaf01.SetOptionState(13, eOptionOn);
	}
	if (X == 15) flags.DlgGreenleaf = 1;
	
	// Start Dolmen Quest...
	if (X == 16) {
	  if (flags.DolmenQuest == 0) {
			flags.DolmenQuest = 1;
			//dGreenleaf01.SetOptionState(6, eOptionOn);
		}
	
	}
	// Greenleaf dark forest conversation
	if (X == 17) {
	  
	  if (flags.Chapter == 1 || flags.DolmenQuest == 0) {
	    cGreenleaf.Say("We dare not speak of it.");
	  }
	  
	  else {
      if (!flags.VisitedDarkForest) {
	      cGreenleaf.Say("You wish to venture into the dark forest? You won't be able to go far. A mysterious darkness always clouds those regions.");
	    }  
	    else {
	      cGreenleaf.Say("A mysterious darkness always clouds these regions. You noticed this, haven't you?");
      }
	  
      if (flags.GreenleafFavor < GREENLEAF_FAVOR_COMPLETE) {
			  cGreenleaf.Say("I can help you get past the barrier of darkness, but first I need to ask a favor of you.");
        dGreenleaf01.SetOptionState(9, eOptionOn);
        dGreenleaf01.SetOptionState(18, eOptionOn);
        dGreenleaf01.SetOptionState(7, eOptionOff);
        dGreenleaf01.SetOptionState(8, eOptionOff);
        dGreenleaf01.SetOptionState(19, eOptionOff);
      }
      else {
			  cGreenleaf.Say("As I've told you before, the only way to see clearly in the dark forest is by drinking the water from this pool just before entering. ");
			  cGreenleaf.Say("One bottle should be able to help you for an hour, so I advise you to take as much as you need. ");
			  cGreenleaf.Say("Be careful and good luck.");
      }
    }
    
	}
	// Greenleaf favor conversation
	if (X == 18) {

	  if (flags.GreenleafFavor == 0) {
      cGreenleaf.Say("The Lauburu grows in Helmsdale, a ruined village in the dark forest. Why'd you ask?");
      Display("You tell Greenleaf about the Duke's illness, and how you need to find the Lauburu to cure him.");
      cGreenleaf.Say("You will need to get past the dark forests wards to enter Helmsdale. I can make you a potion that will do just that, but I'll need you to bring me a fruit from the cliffside.");
	    flags.GreenleafFavor = 1;
	    if (heroinfo.class == CLASS_FIGHTER) {
	      cNiall.ChangeRoom(139, 166, 181);
	    }
	  }
	  else {
	    cGreenleaf.Say("As I said before, the Lauburu grows in Helmsdale within the dark forest. I need you to bring me the fruit from the cliffside, then I make you a potion to allow you through the wards of the darkness.");
	  }
	  
	}
	// show symbol projection
	if (X == 19) {
	  int a = 99;
	  cFernin.LockView(FERNIN_IDLE);
	  cFernin.Animate(0, 2, eOnce, eBlock, eForwards);
	  cFernin.UnlockView();
	  cFernin.Loop = 0;
	  
	  cSymbolproj.ChangeRoom(19);
	  cSymbolproj.Animate(0, 3, eRepeat, eNoBlock, eForwards);
		while (a > 25) {
		  cSymbolproj.Transparency = a;
		  a -= 5;
		  Wait(2);
		}	
		flags.SeenDarkSymbol = true;
	}
	// fade symbol projection
	if (X == 20) {
	  int a = 25;
		while (a < 95) {
		  cSymbolproj.Transparency = a;
		  a += 5;
		  Wait(2);
		}
		cSymbolproj.ChangeRoom(-1);
	}
	
	// smith purchase
	if (X == 21) { // throwing dagger
		PurchaseItem(iThrowingDagger, "You purchase a throwing dagger.");   
	}
	if (X == 22) { // long sword
		PurchaseItem(iLongSword, "You purchase a long sword.");
	}
	if (X == 23) { // chainmail
		PurchaseItem(iChainmail, "You purchase some chainmail.");
	}
	if (X == 24) { // steel shield
		PurchaseItem(iSteelShield, "You purchase a steel shield.");
	}
	if (X == 25) { // tinder
    PurchaseItem(iTinderBox, "You purchase a tinder box.");    
	}
	if (X == 26) { // torch
    PurchaseItem(iTorch, "You purchase a torch.");    
	}
	// goto purchase dialog and activate option
	if (X == 27) {
	  dSmithBuy.SetOptionState(7, eOptionOn);
	}
	if (X == 28) { // buy food rations
    PurchaseItem(iRations, "You purchase some rations.");    
	}
	if (X == 29) { // buy food rations
    PurchaseItem(iFlint, "You purchase a piece of flint.");    
	}	
	
	if (X == 30) {
	  flags.DlgTethra = 2;
	}
	
	if (X == 32) {
	  if (flags.DlgFerninCh2 == 0) {
	    cFernin.Say("Welcome to my shop, young adventurer. It is most fortunate and yet unfortunate that you facilitated the return of our duke.");
      cFernin.Say("You shouldn't have moved him, but it's already too late. The damage has been done.");
      cFernin.Say("Still, it might be possible to fix the problem you caused...");
      flags.DlgFerninCh2 = 1;
    }
    else {
      cFernin.Say("Welcome back adventurer.");
    }
  }
  if (X == 33) {
    if (flags.ThaenIntroduced) {
      dThaen01.SetOptionState(17, eOptionOn);
      dThaen01.SetOptionState(1, eOptionOff);
    }
    else {
      dThaen01.SetOptionState(17, eOptionOff);
      dThaen01.SetOptionState(1, eOptionOn);
    }
  
    if (flags.SeenCh1JobBoard) {
      dThaen01.SetOptionState(22, eOptionOn);
    }
    else {
      dThaen01.SetOptionState(22, eOptionOff);
    }
    if (flags.GolemName == 1) {
      dThaen01.SetOptionState(24, eOptionOn);
      dThaen01.SetOptionState(23, eOptionOff);
    }
    else if (flags.MetMharryon1 == true && flags.GolemName == 0) {
      dThaen01.SetOptionState(23, eOptionOn);
      dThaen01.SetOptionState(24, eOptionOff);
    }    
  }
  if (X == 34) {
    flags.ThaenIntroduced = true;
  }     
  if (X == 35 && heroinfo.class == MAGE) Display("The sheriff eyes you suspiciously for a few seconds. "); 
  
  if (X == 36) flags.AskedThaenAboutLibrary = true;
  
  if (X == 37) {
    if (flags.AskedThaenAboutLibrary) {
      Display("You SURE you wanna be an adventurer? You didn't know what a library is and you don't even know what a graveyard is?");
      Display("Why don't you try a new line of work? Accounting, maybe?");
    }
  }
  
  if (X == 38) { // golem kills you
    GameOverDialog("", "Don't mess with the golem, fool!");
  }

  if (X == 39) { // start golem name quest
    if (flags.GolemName == 0) flags.GolemName = 1;
  }

  if (X == 40) { // get names from veran
    if (flags.GolemName < 2) flags.GolemName = 2;
    dVeran.SetOptionState(26, eOptionOn);
    cEgo.AddInventory(iNameList);
  }

  if (X == 41) {
    if (flags.GolemName == 1) dVeran.SetOptionState(25, eOptionOn);
    else if (flags.GolemName == 2) dVeran.SetOptionState(26, eOptionOn);
  }

  if (X == 42) {
    short a = Random(7);
    if (a == 0) cVeran.Say("Listen to those around you. You never know what fact may save your life.");
    if (a == 1) cVeran.Say("When exploring, be sure you know the quickest way to a place of safety. It wouldn't do to become monster fodder just because you ran the wrong way.");
    if (a == 2) cVeran.Say("Be sure to carry several pieces of food with you at all times, lest you feel the fangs of hunger at the most inopportune moment.");
    if (a == 3) cVeran.Say("Although you have much to do, you should still remember to rest. A tired mind is a slow mind and a tired hand is a weak hand.");
    if (a == 4) cVeran.Say("One man's waste is another man's treasure. Do not discard anything mindlessly. You never know what may be of use to you in the future.");
    if (a == 5) cVeran.Say("Never be ashamed to run from a fight you can't win. There's no glory in getting yourself killed. Of course, if you practice enough, you won't be running very often. I hope.");
    if (a == 6) {
      cVeran.Say("You will someday be asked to fetch magic water. Every adventurer is. Laugh if you must, but this is Natural Law.");
      cVeran.Say("I suggest carrying at least two flasks around at all times. Four if you can afford it. That way, you can always keep a little water for yourself.");
    }
    if (a == 7) cVeran.Say("I've found that when I am particularly perplexed, a visit to the library is refreshing. Even swordsmen must keep their minds engaged.");
  }
  
  if (X == 43) {
    //Display("TODO: Golem bending a sword sprite.");
    cGolem.LockView(GOLEM_BEND);
    cGolem.Animate(0, 2, eOnce, eBlock, eForwards);
    cEgo.AddInventory(iBentSword);
    //object[0].Visible = true;
  }
  if (X == 44) {
    if (flags.ShownBentSwordToRonBars && flags.GolemName == 2) {
      dGlith01.SetOptionState(9, eOptionOn);
    }
  }
  if (X == 45) {
    cFilter.ChangeRoom(cEgo.Room);
    cFilter.Transparency = 100; //TODO --- Check that the light gives the desired effect
    Wait(1);
    Display("TODO: Wagon cut-scene.");
    Display("Ron bars helps you put the portcullis into the wagon, and then both of you set off to meet with the golem.");
    processTime();//Reset light/dark effect
    flags.GolemName = 3;
    cRonbars.ChangeRoom(137, 180, 211);
    cEgo.Loop = 3;
    cRonbars.Loop = 3;
    cEgo.ChangeRoom(137, 155,210); 
  }
  if (X == 46) {
    if (flags.SeenSymbols) dGolem03.SetOptionState(5, eOptionOn);
    else dGolem03.SetOptionState(5, eOptionOff);
    if (cEgo.InventoryQuantity[iDukeSword.ID] == 1) dGolem03.SetOptionState(6, eOptionOn);
    else dGolem03.SetOptionState(6, eOptionOff);
  }
  if (X == 47) {
    flags.AskedGolemAboutSymbols = true;
  }
  if (X == 48) {
    if (checkmoney(0, 10) == false) {
      Display("You didn't realise inflation on food prices was so high. You simply do not have that kind of money.");
    }
    else if (flags.NiallDuel == 0) {
      dNiallBerry.SetOptionState(4, eOptionOff);
      dNiallBerry.SetOptionState(7, eOptionOff);
      dNiallBerry.SetOptionState(8, eOptionOn);
      dNiallBerry.SetOptionState(9, eOptionOn);
    }
    else if (flags.NiallDuel > 0) {
      dNiallBerry2.SetOptionState(2, eOptionOff);
      dNiallBerry2.SetOptionState(3, eOptionOff);
      dNiallBerry2.SetOptionState(4, eOptionOff);
      dNiallBerry2.SetOptionState(5, eOptionOn);
      dNiallBerry2.SetOptionState(6, eOptionOn);
    }
    
  }
  if (X == 49) {
    cNiall.Walk(340, 180, eBlock, eAnywhere);
    cNiall.ChangeRoom(22, 160, 155);
  }
  if (X == 50) {
    cNiall.Walk(340, 180, eBlock, eAnywhere);
    cNiall.ChangeRoom(-1);
    herobuy(0, 10);
    cEgo.AddInventory(iMagicFruit);
  }
  if (X == 51) {
    cNiall.ChangeRoom(22, 160, 155);
    cEgo.ChangeRoom(22, 145, 165);
  }
  if (X == 52) {
    if (heroinfo.hp < (heroinfo.mhp / 4)) {
      cNiall.Say("Seriously, I'm not in the spirit of killing today and you don't look like your fit for a duel. Come back when your ready.");
      return;
    }
    
    cNiall.Say("Get your gold ready, 'cause you'll be paying me once this is over.");
    if (herobuy(0, 1)) {
      PlayMusic(24);
      cNiall.Say("Engarde!");
      RegisterEnemy(cNiall, 7);
      SpawnEnemyCoords(7, cNiall.x, cNiall.y);
      cNiall.ChangeRoom(-1);
      setCombatDeathMode(false);
      setMovementMode(false);
      InitCombat();
      flags.NiallDuel = 2;
    }
    else {
      Display("You don't even have a gold coin.");
    }
  }
}
// Displays random msg when player clicks in a object without interactions */
function unhandled_event(int what, int type) {
  int rand = 0;
  // look
  if (what == 4 && type == 1 || what == 1 && type == 1) {
	  Display("You see nothing of interest");
	}
	// interact
  if (what == 4 && type == 2 || what == 1 && type == 2) {
    rand = Random(3);
    if (rand == 0) Display("That is no place for your hand");
    else if (rand == 1) Display("You'd better not.");
    else if (rand == 2) Display("That wont help.");
    else if (rand == 3) Display("What are you trying to do?");
  }
  // 
  if (what == 4 && type == 3 || what == 1 && type == 3) {
    rand = Random(2);
    if (rand == 0) Display("That doesn't seem to work.");
    else if (rand == 1) Display("These two don't go together.");
    else if (rand == 2) Display("What are you trying to do?");
  }
  //
  if (what == 4 && type == 4 || what == 1 && type == 4) {
    rand = Random(3);
    if (rand == 0) Display("You don't want to put that in your mouth.");
    else if (rand == 1) Display("It doesn't say much.");
    else if (rand == 2) Display("There is no response.");
    else if (rand == 3) Display("Who are you trying to talk to?");
  }
  if (what == 4 && type == 9 || what == 1 && type == 9 || what == 2 && type == 9) {
    CastFetch(mouse.x, mouse.y, null);
  }
  
  
  if (what == 3 && type == 3) {
    Display("He doesn't seem interested");
  }
}
function on_event(EventType event, int data) {

  if (event == eEventLeaveRoom) {
    //flushDrawStarsBuffer(); TODO --- Implement stars on nighttime
    if (data == 102) return;
    heroPrevX = cEgo.x;
    heroPrevY = cEgo.y;
    /*
		if (cEgo.x > (Room.RightEdge - 4)) {
		  cEgo.Walk(335, cEgo.y, eBlock, eAnywhere);
		}
		else if (cEgo.x < (Room.LeftEdge + 4)) {
		  cEgo.Walk(-15, cEgo.y, eBlock, eAnywhere);
		}
		else if (cEgo.y > (Room.BottomEdge - 4)) {
		  cEgo.Walk(cEgo.x, 300, eBlock, eAnywhere);
		}
		else if (cEgo.y < (Room.TopEdge + 4)) {
		  cEgo.Loop = 3;
		}		
		*/
    
  }
  
  if (event == eEventEnterRoomBeforeFadein) {
    onEnterRoom_updCombat(data);
  }
}


/*** AGS.input  *****************************************************************************************************************/
function on_key_press(int keycode) {   // called when a key is pressed. keycode holds the key's ASCII code
  if (IsGamePaused() == 1){
    if(keycode != 27)
      //keycode = 13;
    //else
      keycode=0;  // game paused, so don't react to keypresses except for ESC
  }
  if (keycode==17)  QuitGame(1);                      // Ctrl-Q
  if (keycode==366) startRain();                      // F8
  if (keycode==367) RestartGame();                    // F9
  if (keycode==368  && flags.Chapter > 0) {           // F10
    gShortcuts.Visible = true;
  }
  if (keycode==433) {                                 // F11
    cEgo.x = mouse.x;
    cEgo.y = mouse.y;
  }
  if (keycode==434) SaveScreenShot("scrnshot.bmp");   // F12
  if (keycode==9) iconInv_Click();                    // Tab, show inventory
  if ((keycode==27) && (gOptions.Visible == true))    // ESC
    gOptions.Visible = false;
  if (keycode==67) {                                  // C
    killAllMonsters();
  }
  /*if (keycode==68) {                                  // D - Jump to Albion Road Sign
    cEgo.ChangeRoom(152, 150, 175);
  }*/
 	if (isHeroInCombat() && isMovementEnabled()) {      // arrow keys in combat
	  if (keycode==372) HeroGridMoveUp();               // Up
	  if (keycode==375) HeroGridMoveLeft();             // Left
	  if (keycode==377) HeroGridMoveRight();            // Right
	  if (keycode==380) HeroGridMoveDown();             // Down
	}
  if (keycode==19)  Debug(0,0);                       // Ctrl-S, give all inventory
  if (keycode==22)  Debug(1,0);                       // Ctrl-V, version
  if (keycode==1)   Debug(2,0);                       // Ctrl-A, show walkable areas
  if (keycode==24)  Debug(3,0);                       // Ctrl-X, teleport to room
}

function on_mouse_click(MouseButton button) { //When mouse button is clicked - either LEFT or RIGHT
  if (IsGamePaused() == 1)
  {
    // Game is paused, so do nothing (ie. don't allow mouse click)
  }
  else if (button == eMouseLeft) 
  {
    ProcessClick(mouse.x, mouse.y, mouse.Mode );
    //if (cEgo.ActiveInventory == iSpellFlame && Mouse.Mode == 4) CastFlameDart(mouse.x, mouse.y);
    
    // handle spells
    if (Mouse.Mode == eModeFlameDart && cFlame.Room != cEgo.Room) 
      CastFlameDart(mouse.x, mouse.y);    
  }
  else if (button == eMouseRight) 
  {   // right-click, so cycle cursor
    if(cEgo.Room != 100 && cEgo.Room != 101)
    {
      mouse.SelectNextMode();
      mouse.saveCurrentCursor();
    }
  }
  //else if (button == eMouseWheelNorth) invCustomInv.ScrollUp();
  //else if (button == eMouseWheelSouth) invCustomInv.ScrollDown();
}


/*** AGS.debug *********************************************************************************************************************/
function btnQuestA_Click(GUIControl *control, MouseButton button) {
  flags.BloodSealVersion = false;
  gDolmensetup.Visible = false;
  Display("Quest A");
  
}
function btnQuestB_Click(GUIControl *control, MouseButton button) {
  flags.BloodSealVersion = true;
  gDolmensetup.Visible = false;
  Display("Quest B");
}
function btnChap1_Click(GUIControl *control, MouseButton button) {
  flags.Chapter = 0;
  gChapterselect.Visible = false;
}
function btnChap2_Click(GUIControl *control, MouseButton button) {
  flags.Chapter = 2;
  flags.MobOccuring = 1;
  gChapterselect.Visible = false;
}
function btnChap3_Click(GUIControl *control, MouseButton button) {
  Display("Couldn't resist the curiosity could you? Chapter 3 is far from done right now");
}


/*** AGS.inventory   *****************************************************************************************************************/
function inventory24_a() {
  // script for Inventory item 24 (Healing Potion): Look at inventory item
  
	Display("You have %d healing potions", cEgo.InventoryQuantity[iHealingPotion.ID]);
}
function inventory32_a() {
  // script for Inventory item 32 (Mana Potion): Look at inventory item
  
	Display("You have %d mana potions", cEgo.InventoryQuantity[iManaPotion.ID]);
}
function inventory50_a() {
	// script for Inventory item 50 (Stamina Potion): Look at inventory item
	Display("You have %d stamina potions", cEgo.InventoryQuantity[iStaminaPotion.ID]);
}
function inventory58_a() {
  // script for Inventory item 58 (Money Pouch): Look at inventory item
  
Display("You have %d gold and %d silvers in your pouch", heroinfo.gold, heroinfo.silver);
}
function inventory64_a() {
  // script for Inventory item 64 (SpellFlame): Talk to inventory item
  //Display("oi");
  gSpells.Visible = false;
  
  Mouse.Mode = eModeFlameDart;
  cEgo.SetAsPlayer();
  //Display("oi"); 
}
function inventory64_b() {
  // script for Inventory item 64 (SpellFlame): Interact inventory item
  
  gSpells.Visible = false;
  gIconbar.Visible = true;
  
  Mouse.Mode = eModeFlameDart;
  cEgo.SetAsPlayer();
}
function inventory63_a() {
  // script for Inventory item 63 (Spell Fetch): Talk to inventory item
  
gSpells.Visible = false;
mouse.Mode = eModeFetch;
cEgo.SetAsPlayer();
}

function inventory68_a() {
  // script for Inventory item 68 (Spell Detect Magic): Talk to inventory item
  gSpells.Visible = false;  
  gIconbar.Visible = true;
  if (flags.DolmenQuest == 1 && cEgo.Room == 114) {
    DisplayMessage(533);
  }
  else {
    DisplayMessage(534);
  }
  cEgo.SetAsPlayer();
}

function inventory70_a() {
  // script for Inventory item 70 (Spell Open): Talk to inventory item
  
gSpells.Visible = false;
mouse.Mode = eModeOpen;
cEgo.SetAsPlayer();
}
function inventory72_a() {
  // script for Inventory item 72 (Spell Trigger): Talk to inventory item
  
gSpells.Visible = false;
mouse.Mode = eModeTrigger;
cEgo.SetAsPlayer();
}
function inventory77_a() {
  // script for Inventory item 77 (Torch): Use inventory on this item
  Display("You wouldn't want to set your entire inventory on fire. You decide to wait until a lit torch is needed.");
}
function inventory78_a() {
  // script for Inventory item 78 (Flint): Use inventory on this item
  Display("You wouldn't want to set your entire inventory on fire. You decide to wait until a lit torch is needed.");
}
function inventory80_a() {
  // script for Inventory item 80 (Reman Name List): Look at inventory item
  //Display("You look through the list of names that Veran gave you. The cognomen, 'Cosantóir', catches your eye for it means 'worker of steel'.");  
  Display("You look through the list of names that Veran gave you. The cognomen, 'Cosantoir', catches your eye for it means 'worker of steel'.");  
}
/* Supporting Functions for Inventory??? */
function iDukeSword_Look(){
DisplayMessage(520);
}
function iMagicFruit_Look(){
DisplayMessage(525);
}
function iGoblinTeeth_Look(){
DisplayMessage(526);
}
function iPass_Look(){
DisplayMessage(522);
}
function iRemenBook_Look(){
gui[1].Visible = false;
DisplayMessage(521);
gui[15].Visible = true;
}
function iMPouch_Interact(){
DisplayMessage(518);
}
function iFlaskNullWater_Look(){
DisplayMessage(528);
}
function iGNote_Look(){
DisplayMessage(540);
DisplayMessage(539);
}
function iTorch_UseInv(){
if (player.ActiveInventory == inventory[78]) {
inventory77_a();
}
}
function iFlint_UseInv(){
if (player.ActiveInventory == inventory[77]) {
inventory78_a();
}
}


/*** AGS.character *****************************************************************************************************************/
function character0_a() {
  // script for Character 0 (HERO): Use inventory on character
  

}
function character0_b() {
  // script for Character 0 (HERO): Use inventory on character
  

}
function character0_c() {
  // script for Character 0 (HERO): Use inventory on character
  

}
function character0_d() {
  // script for Character 0 (HERO): Use inventory on character

}
function character0_e() {
  // script for Character 0 (HERO): Interact character
  
int ropeStrength = 45;
  
if (cEgo.View == HEROVIEW) DisplayMessage(998);
else if (cEgo.View == HERO_TIED_MOVE) {
  
  // struggle a bit
  cEgo.LockView(HERO_TIED);
  cEgo.Animate(0, 4, eOnce, eBlock, eForwards);
  
  if (heroinfo.str >= 45) {
    DisplayMessage(544);
    cEgo.Animate(1, 4, eOnce, eBlock, eForwards);
    cEgo.UnlockView();
    cEgo.SetWalkSpeed(4, 4);
  }
  else {
    DisplayMessage(543);
    cEgo.LockView(HERO_TIED_MOVE);
  }
}
}
function character2_a() {
  // script for Character 2 (Town Guard): Use inventory on character
  cGuard01.StopMoving();
  cEgo.Walk(cGuard01.x,  cGuard01.y + 9, eBlock, eWalkableAreas);
  cGuard01.FaceCharacter(cEgo);
  cEgo.FaceCharacter(cGuard01);
  
  if (flags.DukeRescue <= 2 && cGuard01.Room == 11) {
    cGuard01.Say("Hmm, what's this?");
    Display("The guard examines your letter.");
    cGuard01.Say("Very well then. You may enter.");
    flags.DukeRescue = 3;
  }
  else if (flags.DukeRescue > 2 && cGuard01.Room == 11) {
    cGuard01.Say("I've seen it kid! Stop wasting my time.");
  }
}
function character3_a() {
  // script for Character 3 (Shadow Mage): Interact character
  
GenericMonsterUse(cShadowmage);
}
function character5_a() {
  // script for Character 5 (Hobgoblin): Interact character
  
GenericMonsterUse(cGoblin);

}
function character6_a() {
  // script for Character 6 (Llewella): Talk to character
  
  dllewella01.Start();
  /*
if(timeinfo.Day<3) {
  dllewella01.Start();
}
else if((flags.EileenRescue>=0) && (flags.EileenRescue<15)){
  
}
else if(flags.EileenRescue==15) {
  
}
else if (flags.EileenRescue>=16) {
}*/
}
function character9_a() {
  // script for Character 9 (Thaen): Use inventory on character
  
  if (flags.DukeRescue == 1) {
    dThaenShowSword.Start();
    flags.DukeRescue = 2;
    heroinfo.gold += 5;
  }
  else if (flags.DukeRescue == 0) {
    Display("You have no reason to show him the sword.");
  }
  else if (flags.DukeRescue > 1) {
    Display("You've already shown him the sword");
  }
  
}
function character9_b() {
  // script for Character 9 (Thaen): Talk to character
  
if (flags.DukeRescue < 2) dThaen01.Start();
else if (flags.DukeRescue == 2) {  
  cThaen.Say("Don't just stand there, boy! The Duchess will want to see you! Get excited!");
  cThaen.Say("Go through the north gate into the castle courtyard and show the guards the note I gave you. They will escort you to the Duchess.");
}
else if (flags.DukeRescue >= 4) {
  if (flags.SeenSymbols) dThaen03.SetOptionState(2,eOptionOn);
  dThaen03.Start();
}
}
function character12_a() {
  // script for Character 12 (Clay Golem): Interact character
  
GenericMonsterUse(cClaygolem);
}
function character13_a() {
  // script for Character 13 (Wood Golem): Interact character
  
GenericMonsterUse(cWoodgolem);
}
function character17_a() {
  // script for Character 17 (Rowena): Talk to character

if (flags.DlgRowena == 0) { // first time talk
	cRowena.Say("Oh, anothar prospective hero!  Welcome ta Albion's one and only library. I am Rowena, your humble librarian");
	cRowena.Say("Feel free ta look 'round and read,");
	Display("She smiles sweetly at you and winks.");
	flags.DlgRowena = 1;
	dRowena01.Start();
}
else if (flags.DlgRowena == 1) {
  cRowena.Say("Welcome back.");
  dRowena01.Start();
}
	}
function character18_a() {
  // script for Character 18 (Veran): Look at character
  
  Display("He looks back at you calmly. You can't help but feel that you're being sized up.");
}
function VeranPotionResponse() {    //Supporting function for character18 b-d
  cVeran.Say("Keep it. Fernin's potions always make me a touch queasy.");
  cHywell.Say("So he lets the spider bathe in the cauldron now and then. Have some backbone, man!");
  cVeran.Say("Hywel, it's not the spider that bothers me. I am open-minded. But one day, when visiting the shop, I saw him leave the soap in.");
  cVeran.Say("Not that you should hesitate to use them if you need them. They could save you.");
}
function character18_b() {
  // script for Character 18 (Veran): Use inventory on character
  
VeranPotionResponse();
}
function character18_c() {
  // script for Character 18 (Veran): Use inventory on character
VeranPotionResponse();  
}
function character18_d() {
  // script for Character 18 (Veran): Use inventory on character
VeranPotionResponse();  
}
function character18_e() {
  // script for Character 18 (Veran): Use inventory on character
  
cVeran.Say("Thank you for your kindly offer, but I provide my services free of charge.");
}
function character18_f() {
  // script for Character 18 (Veran): Talk to character
  
  if (cVeran.Room == 21) {
    cEgo.Walk(135, 174, eBlock, eWalkableAreas);
  }
  
  dVeran.Start();
}
function character19_a() {
  // script for Character 19 (Hywell): Talk to character
  if (cHywell.Room == 21) {
    cEgo.Walk(179, 174, eBlock, eWalkableAreas);
  }
  
  dHywel01.Start();
  
}
function character22_a() {
  // script for Character 22 (Greenleaf): Talk to character
  cGreenleaf.StopMoving();
  cEgo.Walk(cGreenleaf.x - 9, cGreenleaf.y, eBlock, eWalkableAreas);
	if (flags.MetMharryon1 == true) dGreenleaf01.SetOptionState(10, eOptionOn);
	else dGreenleaf01.SetOptionState(10, eOptionOff);
  
  //if (flags.DolmenQuest > 0) dGreenleaf01.SetOptionState(6, eOptionOn);
  if (flags.AngusNote == 1) {
    cGreenleaf.Say("I see that you've received my message. Good. We have much to discuss.");
    flags.AngusNote = 2;
  }
  else {
    cGreenleaf.Say("Fair weather to you.");
  }
  
  if (!flags.hadStatueCutscene) dGreenleaf01.Start();
  else dGreenleaf03.Start();
}
function character23_a() {
  // script for Character 23 (Belenus): Talk to character
if (flags.Chapter == 1) {
  if (flags.DlgBelenus == 0) {
    cBelenus.Say("Greetings, traveler.  Would you care for one of my many curatives?");
    flags.DlgBelenus = 1;
  }
  else
    cBelenus.Say("Welcome back, adventurer. How is your health today?");
  dBelenus.Start();
}
else if (flags.Chapter == 2 && flags.MobOccuring >= 3) {
  dBelenus04.Start();
}
}
function character23_b() {
  // script for Character 23 (Belenus): Use inventory on character
  
Display("You tell Belenus about the Shadow Mage you fought in the dark forest and show him the cape.");
cBelenus.Say("You took on a shadow mage all by yourself? Impressive.");
cBelenus.Say("You should take that to Fernin. He'll definitely want to see this.");

}
function character23_c() {
  // script for Character 23 (Belenus): Use inventory on character
  
cBelenus.Say("You found it? Wait, these are seeds, and we need the herb to save the Duke.");
cBelenus.Say("I guess we'll have to grow them. They only grow on magical soil.");
cBelenus.Say("Thank you for finding these. There might still be hope left for our Duke.");
}
function character28_a() {
  // script for Character 28 (Fernin): Talk to character
  cEgo.Walk(180, 215,eBlock,eWalkableAreas);
if (flags.Chapter == 1) {
  dFernin01.Start();
}
else if (flags.Chapter == 2) {
  dFernin03.Start();
}
}
function character28_b() {
  // script for Character 28 (Fernin): Use inventory on character
cEgo.Walk(180, 215,eBlock,eWalkableAreas);  
Display("You tell Fernin about the Shadow Mage you fought in the dark forest. When you show him the cape, his eyes appear to glow with interest."); 
cFernin.Say("Excellent work. Let me have a look."); 
Display("Fernin examines the cape."); 
cFernin.Say("Hmmmmm. This is most peculiar. I will need some time alone to properly examine this."); 
cFernin.Say("I will discuss with you my findings tomorrow. I must not be disturbed; my shop will be closed until tomorrow morning."); 
cFernin.Say("Farewell."); 
cEgo.LoseInventory(iShadowCape);

// set quest flags
flags.DolmenQuest = 4; // complete dolmen quest
flags.DayTheMagicShopReopens = timeinfo.Day + 1; // magic shop reopens tomorrow
flags.DisturbedFernin = 1; // do not disturb

//Display("You have completed the Dolmen Quest.");
cFernin.LockView(FERNIN_APPEAR);
cFernin.Animate(0, 2, eOnce, eBlock, eBackwards);


cEgo.Walk(7, 226, eBlock, eWalkableAreas);
cEgo.ChangeRoom(3, 248, 170);
cEgo.UnlockView();
cEgo.Loop = 1;
}
function character29_a() {
  // script for Character 29 (Niall): Talk to character

if (cNiall.Room == 22 && flags.GreenleafFavor == 1) {
  
  if (flags.NiallDuel == 0) {
    cEgo.Walk(cNiall.x - 12, cNiall.y - 8, eBlock, eWalkableAreas);
    cNiall.Say("TODO: Ok. Here's the deal. I bet my berries, you bet a gold coin. If I win, I keep the berries and earn a shiny new coin. If you win, you get the berries and you keep your money.");
    flags.NiallDuel = 1;
    
    if (herobuy(0, 1)) {
      PlayMusic(24);
      cNiall.Say("Engarde!");
      RegisterEnemy(cNiall, 7);
      SpawnEnemyCoords(7, cNiall.x, cNiall.y);
      cNiall.ChangeRoom(-1);
      setCombatDeathMode(false);
      setMovementMode(false);
      InitCombat();
      flags.NiallDuel = 2;
    }
    else {
      Display("You don't even have a gold coin.");
    }
  }
  else if (flags.NiallDuel == 1) {
    cEgo.Walk(cNiall.x - 12, cNiall.y - 8, eBlock, eWalkableAreas);
    dNiallBerry2.Start();
  }
  else if (flags.NiallDuel > 1) {
    //dNiallBerry2.Start();
  }  

  
}
}
function character36_a() {
  // script for Character 36 (Glith): Talk to character
  
//cGlith.Say("I have no placeholder dialog yet. But we can still do business.");
//dStoreBuy.SetOptionState(17, eOptionOn);
//dStoreBuy.Start();
dGlith01.Start();
}
function character36_b() {
  // script for Character 36 (Glith): Use inventory on character
  
dStoreBuy.Start();
}
function character37_a() {
  // script for Character 37 (Shadow Mage Dolmen): Use inventory on character

if (!sneakingMode) return;
if (!IsHeroCloseEnough) return;

DisplayMessage(542);

flags.DolmenQuest = 2;


cShadowmagedolm.LockView(cShadowmagedolm.GetProperty("CombatView"));

// todo - uncomment this
//enemyDie(cShadowmagedolm);

SetSneakingMode(0);
}
function showSwordToRonBars() {   //Supporting function for character42
  // script for Character 42 (Ron Bars): Use inventory on character

if (flags.GolemName < 2) {
  Display("You have no reason to show him the bent sword right now.");
  return;
}

if (!flags.ShownBentSwordToRonBars) {
  cEgo.Walk(203, 200, eBlock, eWalkableAreas);
  flags.ShownBentSwordToRonBars = true;
  cRonbars.Say("Unbelievable!");
  Display("Ron Bars examines the bent sword.");
  cRonbars.Say("Whoever did this must have had the strength of ten men! Who did this?");
  Display("You tell the blacksmith about the golem.");
  cRonbars.Say("Can he come here to fix the gate? He'd probably have it done in a blink of an eye!");
  Display("You tell him that the golem does not wish to leave the caves.");
  cRonbars.Say("He can't come here? Then we'll have to bring the gate to him, but how will we do that?");
  cRonbars.Say("I suppose we could dig it out and cart it through the forest, if we have a big wagon or cart of some kind...");
  cRonbars.Say("Go and see Glith about using his wagon. I hope it ain't too damaged after the last time. Tell him that I sent you.");
}
else {
  cRonbars.Say("I've already seen it. Though I'm still bewildered that the creature could bend it so effortlessly.");
} 
}
function character42_a() {
  // script for Character 42 (Ron Bars): Talk to character
  
cRonbars.Say("Good day to you.");
dRonBars01.Start();
}
function character43_a() {
  // script for Character 43 (Enemy1): Interact character
  
GenericMonsterUse(cEnemy1);
}
function character44_a() {
  // script for Character 44 (Enemy2): Interact character
  
GenericMonsterUse(cEnemy2);
}
function character45_a() {
  // script for Character 45 (Enemy3): Interact character
  
GenericMonsterUse(cEnemy3);
}
function character46_a() {
  // script for Character 46 (Enemy4): Interact character
  
GenericMonsterUse(cEnemy4);
}
function character47_a() {
  // script for Character 47 (Enemy5): Interact character
  
GenericMonsterUse(cEnemy5);
}
function character48_a() {
  // script for Character 48 (Enemy6): Interact character
  
GenericMonsterUse(cEnemy6);
}
function character52_a() {
  // script for Character 52 (Golem Friend): Talk to character
  
if (flags.AlbionGateFixed || flags.GolemName >= 4) {
  dGolem03.Start();
}
else {
  dGolem02.Start();
}
}
/* Supporting functions for characters??? */
function cEgo_Look(){
DisplayMessage(999);
}
function cEgo_Talk(){
DisplayMessage(997);
}
function cEgo_UseInv(){
if (player.ActiveInventory == inventory[iHealingPotion.ID]) {
  heroinfo.hp += (heroinfo.mhp / 3);
  Display("The healing potion soothes and refreshes you as your cuts quickly begin to heal.");
  cEgo.LoseInventory(iHealingPotion);
  cEgo.AddInventory(iEmptyFlask);
}
if (player.ActiveInventory == inventory[iManaPotion.ID]) {
  heroinfo.mp += (heroinfo.mmp / 3);
  DisplayMessage(516);
  cEgo.LoseInventory(iManaPotion);
  cEgo.AddInventory(iEmptyFlask);
}
if (player.ActiveInventory == inventory[iStaminaPotion.ID]) {
  heroinfo.sp += (heroinfo.msp / 2);
  DisplayMessage(517);
  cEgo.LoseInventory(iStaminaPotion);
  cEgo.AddInventory(iEmptyFlask);
}
if (player.ActiveInventory == inventory[2]) {
DisplayMessage(523);
}
if (player.ActiveInventory == inventory[42]) {
DisplayMessage(521);
gui[15].Visible = true;
}
if (player.ActiveInventory == inventory[12]) {
DisplayMessage(527);
}
if (player.ActiveInventory == inventory[73]) {
  flags.CanSeeInDarkForest = true;
  DisplayMessage(529);
  //cEgo.LoseInventory(iFlaskNullWater);
  cEgo.AddInventory(iEmptyFlask);

  if (cEgo.Room == 113) {
    //TODO --- Code for darkness offset no longer applies with the new Day & Night Engine, find another solution
    //darknessOffset = 0;
  }
}
if (player.ActiveInventory == inventory[13]) {
}

}
function cGuard01_Look(){
DisplayMessage(500);
}
function cGuard01_Talk(){
DisplayMessage(502);
}
function cGuard01_UseInv(){
if (player.ActiveInventory == inventory[19]) {
character2_a();
}
}
function cThaen_UseInv(){
if (player.ActiveInventory == inventory[2]) {
character9_a();
}
}
function cJulian_Talk(){
dialog[9].Start();
}
function cVeran_UseInv(){
if (player.ActiveInventory == inventory[24]) {
character18_b();
}
if (player.ActiveInventory == inventory[32]) {
character18_c();
}
if (player.ActiveInventory == inventory[50]) {
character18_d();
}
if (player.ActiveInventory == inventory[58]) {
character18_e();
}
}
function cColin_Talk(){
dialog[5].Start();
}
function cBelenus_UseInv(){
if (player.ActiveInventory == inventory[58]) {
dialog[10].Start();
}
if (player.ActiveInventory == inventory[74]) {
character23_b();
}
if (player.ActiveInventory == inventory[81]) {
character23_c();
}
}
function cFernin_UseInv(){
if (player.ActiveInventory == inventory[74]) {
character28_b();
}
}
function cGlith_UseInv(){
if (player.ActiveInventory == inventory[58]) {
character36_b();
}
}
function cShadowmagedolm_Look(){
DisplayMessage(541);
}
function cShadowmagedolm_UseInv(){
if (player.ActiveInventory == inventory[13]) {
character37_a();
}
}
function cRonbars_UseInv(){
if (player.ActiveInventory == inventory[58]) {
dialog[19].SetOptionState(8, eOptionOn);
dialog[19].Start();
}
if (player.ActiveInventory == inventory[31]) {
  showSwordToRonBars();
}
}
function cRoguemonster_UseInv(){
  if (player.ActiveInventory == inventory[iDagger.ID] && cRoguemonster.Room == 9) {
    SetGlobalInt(1, 1);

    // pass into room 9 script
  }
  
}



/* The following are GUIs that have been moved to external scripts */
/*** AGS.gui.spellsBtn *********************************************************************************************************************
 *** These functions have been relocated to SpellsGUI script for modularization *******************************************************/
function btnSpellPoint_Click(GUIControl *control, MouseButton button) {
	spellPoint_Click();
}
function btnSpellOK_Click(GUIControl *control, MouseButton button) {
	spellOK_Click();
}
/*** AGS.gui.inventoryBtn *****************************************************************************************************************
 *** These functions have been relocated to InventoryGUI script for modularization *******************************************************/
function btnInvUp_Click(GUIControl *control, MouseButton button) {
  invUp_Click();
}
function btnInvDown_Click(GUIControl *control, MouseButton button) {
  invDown_Click();
}
function btnInvOK_Click(GUIControl *control, MouseButton button) {
  invOK_Click();
}
function btnInvSelect_Click(GUIControl *control, MouseButton button) {
  invSelect_Click();
} 
/*** AGS.gui.iconBtn *****************************************************************************************************************
 *** These functions have been relocated to IconbarGUI script for modularization *******************************************************/
function btnIconWalk_Click(GUIControl *control, MouseButton button) {
  iconWalk_Click();
}
function btnIconLook_Click(GUIControl *control, MouseButton button){
  iconLook_Click();
}
function btnIconInteract_Click(GUIControl *control, MouseButton button){
  iconInteract_Click();
}
function btnIconTalk_Click(GUIControl *control, MouseButton button){
  iconTalk_Click();
}
function btnIconStar_Click(GUIControl *control, MouseButton button) {
  iconStar_Click();
}
function btnIconMagic_Click(GUIControl *control, MouseButton button) {
  iconMagic_Click();
}
function btnIconCurInv_Click(GUIControl *control, MouseButton button) {
  iconCurInv_Click();
}
function btnIconInv_Click(GUIControl *control, MouseButton button) {
  iconInv_Click();
}
function btnOptions_Click(GUIControl *control, MouseButton button) {
  options_Click();
}
/*** AGS.gui.combatBtn   *****************************************************************************************************************
 *** These functions have been relocated to CombatGUI script for modularization *******************************************************/
function btnThrust_Click(GUIControl *control, MouseButton button) {
  thrust_Click();
}
function btnSlash_Click(GUIControl *control, MouseButton button) {
  slash_Click();
}
function btnSlice_Click(GUIControl *control, MouseButton button) {
  slice_Click();
}
function btnDodge_Click(GUIControl *control, MouseButton button) {
  dodge_Click();
}
function btnBlock_Click(GUIControl *control, MouseButton button) {
  block_Click();
}
function btnRunAway_Click(GUIControl *control, MouseButton button) {
  runAway_Click();
}
function btnFlame_Click(GUIControl *control, MouseButton button) {
  flame_Click();
}
/*** AGS.gui.setStatsBtn   *****************************************************************************************************************
 *** These functions have been relocated to CharacterSheetGUI script for modularization *******************************************************/
function btnAddStr_Click(GUIControl *control, MouseButton button) {
	addStr_Click();
}
function btnAddInt_Click(GUIControl *control, MouseButton button) {
	  addInt_Click();
}
function btnAddAgi_Click(GUIControl *control, MouseButton button) {
	  addAgi_Click();
}
function btnAddVit_Click(GUIControl *control, MouseButton button) {
	addVit_Click();
}
function btnAddLuck_Click(GUIControl *control, MouseButton button) {
	addLuck_Click();
}
function btnAddMagic_Click(GUIControl *control, MouseButton button) {
	addMagic_Click();
}
function btnAddWeaponUse_Click(GUIControl *control, MouseButton button) {
	addWeaponUse_Click();
}
function btnAddParry_Click(GUIControl *control, MouseButton button) {
	addParry_Click();
}
function btnAddDodge_Click(GUIControl *control, MouseButton button) {
	addDodge_Click();
}
function btnAddThrow_Click(GUIControl *control, MouseButton button) {
	addThrow_Click();
}
function btnAddClimb_Click(GUIControl *control, MouseButton button) {
	addClimb_Click();
}
function btnAddStealth_Click(GUIControl *control, MouseButton button) {
	addStealth_Click();
}
function btnAddLock_Click(GUIControl *control, MouseButton button) {
	addLock_Click();
}
function btnSubStr_Click(GUIControl *control, MouseButton button) {
  subStr_Click();
}
function btnSubInt_Click(GUIControl *control, MouseButton button) {
    subInt_Click();
}
function btnSubAgi_Click(GUIControl *control, MouseButton button) {
  subAgi_Click();
}
function btnSubVit_Click(GUIControl *control, MouseButton button) {
  subVit_Click();
}
function btnSubLuck_Click(GUIControl *control, MouseButton button) {
  subLuck_Click();
}
function btnSubMagic_Click(GUIControl *control, MouseButton button) {
  subMagic_Click();
}
function btnSubWeaponUse_Click(GUIControl *control, MouseButton button) {
  subWeaponUse_Click();
}
function btnSubParry_Click(GUIControl *control, MouseButton button) {
  subParry_Click();
}
function btnSubDodge_Click(GUIControl *control, MouseButton button) {
  subDodge_Click();
}
function btnSubThrow_Click(GUIControl *control, MouseButton button) {
  subThrow_Click();
}
function btnSubClimb_Click(GUIControl *control, MouseButton button) {
  subClimb_Click();
}
function btnSubStealth_Click(GUIControl *control, MouseButton button) {
  subStealth_Click();
}
function btnSubLock_Click(GUIControl *control, MouseButton button) {
  subLock_Click();
}
function btnBack_Click(GUIControl *control, MouseButton button) {
  back_Click();
}
function btnStart_Click(GUIControl *control, MouseButton button) {
  start_Click();
}
/*** AGS.gui.submenuBtn   *****************************************************************************************************************
 *** These functions have been relocated to SubMenuGUI script for modularization *******************************************************/
function btnViewCharSheet_Click(GUIControl *control, MouseButton button) {
  viewCharSheet_Click();
}
function btnSubClose_Click(GUIControl *control, MouseButton button) {
  subClose_Click();
}
function btnTime_Click(GUIControl *control, MouseButton button) {
  time_Click();
}
function btnSneak_Click(GUIControl *control, MouseButton button) {
  sneak_Click();
}
function btnRun_Click(GUIControl *control, MouseButton button) {
  run_Click();
}
function btnRest10mins_Click(GUIControl *control, MouseButton button) {
  rest10mins_Click();
}
function btnRest30mins_Click(GUIControl *control, MouseButton button) {
  rest30mins_Click();
}
function btnRest60mins_Click(GUIControl *control, MouseButton button) {
  rest60mins_Click();
}
function btnRestCancel_Click(GUIControl *control, MouseButton button) {
  restCancel_Click();
}
function btnRest_Click(GUIControl *control, MouseButton button) {
  rest_Click();
}
function btnRestSleep_Click(GUIControl *control, MouseButton button) {
  restSleep_Click();
}
/*** AGS.gui.optionsBtn *****************************************************************************************************************
 *** These functions have been relocated to OptionsGUI script for modularization *******************************************************/
function btnSaveGame_Click(GUIControl *control, MouseButton button) {
  saveGame_Click();
}
function btnLoadGame_Click(GUIControl *control, MouseButton button) {
  loadGame_Click();
}
function btnRestartGame_Click(GUIControl *control, MouseButton button) {
  restartGame_Click();
}
function btnQuitGame_Click(GUIControl *control, MouseButton button) {
  quitGame_Click();
}
function BtnReturn_Click(GUIControl *control, MouseButton button) {
  return_Click();
}
function btnGameSpeedSlider_Change(GUIControl *control) {
  gameSpeedSlider_Change();
}
function btnSliderVolume_Change(GUIControl *control) {
  sliderVolume_Change();
}
function btnSliderDetail_Change(GUIControl *control) {
  sliderDetail_Change();
}
/*** These functions appear to be from an old implementation of the Options GUI. ***/
/*function btnIconSave_Click(GUIControl *control, MouseButton button) {
  iconSave_Click();
}

function btnIconLoad_Click(GUIControl *control, MouseButton button) {
  iconLoad_Click();
}

function btnIconExit_Click(GUIControl *control, MouseButton button) {
  iconExit_Click();
}

function btnIconAbout_Click(GUIControl *control, MouseButton button) {
  iconAbout_Click();
}
*/
/*** AGS.gui.Nameselect **************************************************************************************************************
 *** These functions have been relocated to NameSelectGUI script for modularization *******************************************************/
function btnNameCancel_Click(GUIControl *control, MouseButton button) {
  nameCancel_Click();
}
function btnNameOK_Click(GUIControl *control, MouseButton button) {
  nameOK_Click();
}
function txtName_OnActivate(GUIControl *control){
  nameOK_Click();  // Allows user to complete entry of text with ENTER in addition to clicking OK
}
/*** AGS.gui.Gameover ****************************************************************************************************************
 *** These functions have been relocated to NameSelectGUI script for modularization **************************************************/
function btnGQuit_Click(GUIControl *control, MouseButton button) {
  gQuit_Click();
}
function btnGRestart_Click(GUIControl *control, MouseButton button) {
  gRestart_Click();
}
function btnGRestore_Click(GUIControl *control, MouseButton button) {
  gRestore_Click();
}
function btnGTryAgain_Click(GUIControl *control, MouseButton button) {
	gTryAgain_Click();
}
/*** AGS.gui.Shortcuts ***************************************************************************************************************
 *** These functions have been relocated to ShortcutsGUI script for modularization **************************************************/
function btnWarpDF_Click(GUIControl *control, MouseButton button) {
  warpDF_Click();
}
function btnWarpTower_Click(GUIControl *control, MouseButton button) {
  warpTower_Click();
}
function btnWarpGreenleaf_Click(GUIControl *control, MouseButton button) {
  warpGreenleaf_Click();
}
function btnWarpAlbion_Click(GUIControl *control, MouseButton button) {
  warpAlbion_Click();
}
function btnWarpCaves_Click(GUIControl *control, MouseButton button) {
  warpCaves_Click();
}
function btnWarpClose_Click(GUIControl *control, MouseButton button) {
  warpClose_Click();
}
function btnCutEStatue_Click(GUIControl *control, MouseButton button) {
  cutEStatue_Click();
}
function btnStartBerryDuel_Click(GUIControl *control, MouseButton button) {
  startBerryDuel_Click();
}
/*** AGS.gui.JobBoard *****************************************************************************************************************
 *** These functions have been relocated to JobBoardGUI script for modularization **************************************************/
function btnJobBoardClose_Click(GUIControl *control, MouseButton button) {
  jobBoardClose_Click();
}
function btnJobPoster1_Click(GUIControl *control, MouseButton button) {
  jobPoster1_Click();
}
/*** AGS.gui.Book *****************************************************************************************************************
 *** These functions have been relocated to BookGUI script for modularization **************************************************/
function btnBookClose_Click(GUIControl *control, MouseButton button) {
  bookClose_Click();
}
function btnBookLeft_Click(GUIControl *control, MouseButton button) {
  bookLeft_Click();
}
function btnBookRight_Click(GUIControl *control, MouseButton button) {
  bookRight_Click();  
}
function btnRiddleOK_Click(GUIControl *control, MouseButton button) {
  riddleOK_Click();
}
/*** Unused Code Follows ***/
/*** AGS.gui.TitleGUI ******************************************************************************************************************/
/*** These functions support an old implementation of the title menu ***/
/*
function btnTNewGame_Click(GUIControl *control, MouseButton button) {
  gTitlegui.Visible = false;
  darknessOffset = 0;
  ProcessDayAndNight();
  cEgo.Transparency = 0;
  cEgo.ChangeRoom(101);
}

function btnTLoadGame_Click(GUIControl *control, MouseButton button) {
  LoadGame();
}

function btnTQuit_Click(GUIControl *control, MouseButton button) {
  QuitGame(0);
}

function btnTOptions_Click(GUIControl *control, MouseButton button) {
  
}
*/
/*** This is an old function supporting the commentary system (used in development) ***/
/*function btnCommentary_Click(GUIControl *control, MouseButton button) {
  StartCommentary();
}*/
function btnReroll_OnClick(GUIControl *control, MouseButton button)
{
  reroll_Click();
}

function btnCancelSaveLoadGame_OnClick(GUIControl *control, MouseButton button)
{
  cancelSaveLoadGame_OnClick();
}

function btnSave_OnClick(GUIControl *control, MouseButton button)
{
  save_OnClick(control, button);
}

function lstSaveGames_OnSelectionChange(GUIControl *control)
{
  saveGames_OnSelectionChange(control);
}

function btnDeleteSaveGame_OnClick(GUIControl *control, MouseButton button)
{
  deleteSaveGame_OnClick(control, button);
}

function btnLoad_OnClick(GUIControl *control, MouseButton button)
{
  load_OnClick(control, button);
}